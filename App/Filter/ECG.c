/*********************************************************************************************************
* 模块名称: XXX.c
* 摘    要: 模块实现具体功能
* 当前版本: 1.0.0
* 作    者: XXX
* 完成日期: 2024年12月14日
* 内    容:
* 注    意:
**********************************************************************************************************
* 取代版本:
* 作    者:
* 完成日期:
* 修改内容:
* 修改文件:
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include "ECG.h"
#include "DataType.h"
#include "ADC.h"
#include "UART1.h"
#include "ProcHostCmd.h"
#include "PackUnpack.h"
#include "SendDataToHost.h"
/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/
#define ECG_ADC_arrMAX 100
/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
void ECG_LEADOFF_Check(void);              //检查导联脱落（这里引脚待补充）
void ECG_Start_Check(void);                //检查开始测量信号Flag
u16 ECG_ADC_Read(void);          //存入单个读取的数据，返回目前数组数据量
void ECG_Filter_IIR(void);               //滤波
void ECG_HeartRate_Calculate(void);      //计算心率
void ECG_Wave_Send(void);                //发送数据
/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/

/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: ECG_Task
* 函数功能: 心电测量任务主入口
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/

void ECG_Task()
{
  u16 wave_num=0;
  
  ECG_LEADOFF_Check();              //检查导联脱落（这里引脚待补充）
  ECG_Start_Check();                //检查开始测量信号Flag
  wave_num=ECG_ADC_Read();          //存入单个读取的数据，返回目前数组数据量
  if(wave_num>=ECG_ADC_arrMAX)      //当存满了
  {
    ECG_Filter_IIR();               //滤波
    ECG_HeartRate_Calculate();      //计算心率
    ECG_Wave_Send();                //发送数据
  }
}

/*********************************************************************************************************
* 函数名称: ECG_LEADOFF_Check
* 函数功能: 心电导联脱落Flag检测
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_LEADOFF_Check()
{
  
}

/*********************************************************************************************************
* 函数名称: ECG_Start_Check
* 函数功能: 心电开始测量Flag检测
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_Start_Check()
{
  
}

/*********************************************************************************************************
* 函数名称: ECG_ADC_Read
* 函数功能: 心电ADC值读取存入
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
u16 ECG_ADC_Read()
{
  
}

/*********************************************************************************************************
* 函数名称: ECG_Filter_IIR
* 函数功能: 心电IIR滤波
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_Filter_IIR()
{
  
}

/*********************************************************************************************************
* 函数名称: ECG_HeartRate_Calculate
* 函数功能: 心电心率计算
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_HeartRate_Calculate()
{
  
}

/*********************************************************************************************************
* 函数名称: ECG_Wave_Send
* 函数功能: 心电波形数据发送
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_Wave_Send()
{
  
}
/*********************************************************************************************************
* 函数名称: XXX仅仅保存历史开发遗留函数防止以后要用
* 函数功能: XXX
* 输入参数: void/int/...
* 输出参数: void/int/...
* 返 回 值: void/int/...
* 创建日期: 2024年12月14日
* 注    意:
*********************************************************************************************************/
void ECGTask1()
{
  u16 adcData;                      //队列数据
  float  waveData;                  //波形数据
  
  static u8 s_iCnt4 = 0;            //计数器
  static u8 s_iPointCnt = 0;        //波形数据包的点计数器
  static u8 s_arrWaveData[5] = {0}; //初始化数组
  s_iCnt4++;                        //计数增加

  if(s_iCnt4 >= 4)                  //达到8ms
  {
    if(ReadADCBuf(&adcData))        //从缓存队列中取出1个数据
    {
      waveData = (adcData * 3.3) / 4095;      //计算获取点的位置
      //printf("%f\n",waveData);
      s_arrWaveData[s_iPointCnt] = waveData;  //存放到数组
      s_iPointCnt++;                          //波形数据包的点计数器加1操作

      if(s_iPointCnt >= 5)                    //接收到5个点
      {
        s_iPointCnt = 0;                      //计数器清零
        SendWaveToHost(s_arrWaveData);        //发送波形数据包
      }
    }
    s_iCnt4 = 0;                              //准备下次的循环
  }
}
