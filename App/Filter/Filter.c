/*********************************************************************************************************
* 模块名称: XXX.c
* 摘    要: 模块实现具体功能
* 当前版本: 1.0.0
* 作    者: XXX
* 完成日期: 2024年12月14日
* 内    容:
* 注    意:
**********************************************************************************************************
* 取代版本:
* 作    者:
* 完成日期:
* 修改内容:
* 修改文件:
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include "Filter.h"
#include "DataType.h"
#include "UART1.h"
#include <math.h>
#include "IIR8Filter.h"
#include <string.h>
/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/
int ECG_Filter_Flag=1;    //默认IIR滤波
/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
void ECG_Filter_IIR(double* x, int N);               //滤波
double  IIRFilterc(const double* b, const double* a, int n, int ns, double* px, double* py, double x);

/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/

/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: ECG_Filter
* 函数功能: 心电滤波任务主入口
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_Filter(double* x, int N)
{
  switch(ECG_Filter_Flag)
  {
    case 0:
      break;
    case 1:
      ECG_Filter_IIR(x,N);
      break;
    default:
      printf("ERROR:滤波器选择错误");
      break;
  }
}

/*********************************************************************************************************
* 函数名称: ECG_Filter_IIR
* 函数功能: 心电IIR滤波
* 输入参数: double* x ：输入数据的地址
            int N ：数据个数
* 输出参数: void
* 返 回 值: void
* 创建日期: 2025年11月26日
* 注    意:
*********************************************************************************************************/
void ECG_Filter_IIR(double* x, int N)
{
    // 初始化各节的缓存（px和py初始化为0）
    int n = 2;                  // 每节阶数（二阶节）
    int ns = MWSPT_NSEC;        // 总节数（9节）
    double px[50];
    double py[50];
    *x=IIRFilterc(&NUM[1][1],&DEN[1][1],n,ns,px,py,*x);
 }

/*********************************************************************************************************
* 函数名称： IIRFilterc
* 函数功能： 级联型 IIR 数字滤波器
* 输入参数： b  ：双精度实型二维数组，体积为 ns*（n+1）。存放滤波器分子多项式的系数，
*                 b[j][i] 表示第 j 个 n 阶节的分子多项式的第 i 个系数。
*            a  ：双精度实型二维数组，体积为 ns*（n+1）。存放滤波器分母多项式的系数，
*                 a[j][i] 表示第 j 个 n 阶节的分母多项式的第 i 个系数。
*            n  ：整型变量。级联型滤波器每节的阶数。
*            ns ：整形变量。级联型滤波器的 n 阶节数 L。
*            px ：双精度实型二维数组，体积为 ns*（n+1）。存放历史输入数据，初始状态必须为零。
*            py ：双精度实型二维数组，体积为 ns*（n+1）。存放历史输入数据，初始状态必须为零。
*            x  ：双精度实型变量。新的采样值；
* 输出参数： void
* 返 回 值： 滤波后的采样值
* 创建日期： 2023年10月10日
* 注    意：
*********************************************************************************************************/
double  IIRFilterc(const double* b, const double* a, int n, int ns, double* px, double* py, double x)
{
  int i, j, n1;
  n1 = n + 1;
  for (j = 0; j < ns; j++)
  {
    px[j * n1 + 0] = x;
    x = b[j * n1 + 0] * px[j * n1 + 0];
    for (i = 1; i <= n; i++)
    {
      x += b[j * n1 + i] * px[j * n1 + i] - a[j * n1 + i] * py[j * n1 + i];
    }
    for (i = n; i >= 2; i--)
    {
      px[j * n1 + i] = px[j * n1 + i - 1];
      py[j * n1 + i] = py[j * n1 + i - 1];
    }
    px[j * n1 + 1] = px[j * n1 + 0];
    py[j * n1 + 1] = x;
  }
  return x;
}
